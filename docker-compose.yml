version: '3.8'

services:
  # ============================================
  # FRONTEND - Dashboard UI
  # ============================================
  dashboard:
    build:
      context: .
      dockerfile: ./infra/docker/Dockerfile.dashboard
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_API_URL=http://api:4000
      - NEXT_PUBLIC_WS_URL=ws://api:4001
    networks:
      - frontend
      - backend
    depends_on:
      - api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`${WORKSPACE_DOMAIN:-localhost}`)"
      - "traefik.http.services.dashboard.loadbalancer.server.port=3001"

  # ============================================
  # BACKEND - API Server
  # ============================================
  api:
    build:
      context: .
      dockerfile: ./infra/docker/Dockerfile.api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=4000
      - WS_PORT=4001
      - DATABASE_PATH=/data/workspace.db
      - OPENCLAW_GATEWAY_URL=http://openclaw:3000
      - OPENCLAW_WS_URL=ws://openclaw:3000/ws
    volumes:
      - api-data:/data
    networks:
      - backend
      - openclaw-net
    depends_on:
      - openclaw
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # OPENCLAW - AI Agent Core (SANDBOXED)
  # ============================================
  openclaw:
    image: openclaw/openclaw:latest
    restart: unless-stopped

    # SECURITY: Read-only filesystem
    read_only: true

    # SECURITY: Drop all capabilities
    cap_drop:
      - ALL

    # SECURITY: No privilege escalation
    security_opt:
      - no-new-privileges:true

    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M

    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENCLAW_STATE_DIR=/data

    volumes:
      # ONLY mount data directory - OpenClaw cannot access code
      - openclaw-data:/data
      # Temp for runtime
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100M

    networks:
      # Isolated network - only backend can access
      - openclaw-net

    command: ["openclaw", "gateway", "--bind", "0.0.0.0:3000"]

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # REVERSE PROXY - Traefik
  # ============================================
  traefik:
    image: traefik:v3.0
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/letsencrypt
    networks:
      - frontend

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true  # No external access
  openclaw-net:
    driver: bridge
    internal: true  # Completely isolated

volumes:
  api-data:
  openclaw-data:
  traefik-certs:
